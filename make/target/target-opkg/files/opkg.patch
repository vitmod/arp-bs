diff --git a/libopkg/pkg.c b/libopkg/pkg.c
index d8c3984..cdcd39a 100644
--- a/libopkg/pkg.c
+++ b/libopkg/pkg.c
@@ -738,6 +738,7 @@ pkg_formatted_field(FILE *fp, pkg_t *pkg, const char *field)
 	       if (pkg->provides_count > 1) {
                   fprintf(fp, "Provides:");
 		  for(i = 1; i < pkg->provides_count; i++) {
+                      if (!pkg->provides[i]) break;
                       fprintf(fp, "%s %s", i == 1 ? "" : ",",
 				      pkg->provides[i]->name);
                   }
diff --git a/libbb/unarchive.c b/libbb/unarchive.c
index d583767..703d8d0 100644
--- a/libbb/unarchive.c
+++ b/libbb/unarchive.c
@@ -448,12 +448,12 @@ static bool update_unamecache(char *uname) {
 	struct passwd *passwd;
 	if (!uname)
 		return FALSE;
-	if (!uname_cache[0] && strcmp(uname_cache, uname) == 0)
+	if (strcmp(uname_cache, uname) == 0)
 		return TRUE;
 	passwd = getpwnam(uname);
 	if (passwd) {
 		uid_cache = passwd->pw_uid;
-		strncpy(uname, uname_cache, 32);
+		strncpy(uname_cache, uname, 32);
 		return TRUE;
 	}
 	return FALSE;
@@ -466,12 +466,12 @@ static bool update_gnamecache(char *gname) {
 	struct group *group;
 	if (!gname)
 		return FALSE;
-	if (!gname_cache[0] && strcmp(gname_cache, gname) == 0)
+	if (strcmp(gname_cache, gname) == 0)
 		return TRUE;
 	group = getgrnam(gname);
 	if (group) {
 		gid_cache = group->gr_gid;
-		strncpy(gname, gname_cache, 32);
+		strncpy(gname_cache, gname, 32);
 		return TRUE;
 	}
 	return FALSE;
From 6d451766c5114593b67e1be8c19610f7d377edb5 Mon Sep 17 00:00:00 2001
From: pieterg <pieterg@users.sourceforge.net>
Date: Sun, 1 Sep 2013 19:29:56 +0200
Subject: [PATCH] reuse the installed_files list when possible

rebuilding it for every single file in a package
adds a lot of overhead, especially when updating
packages containing large numbers of files
---
 libopkg/opkg_install.c |    2 +-
 libopkg/pkg_hash.c     |   18 ++++++++++++++++++
 libopkg/pkg_hash.h     |    1 +
 3 files changed, 20 insertions(+), 1 deletion(-)

diff --git a/libopkg/opkg_install.c b/libopkg/opkg_install.c
index 30d9c03..c1c88aa 100644
--- a/libopkg/opkg_install.c
+++ b/libopkg/opkg_install.c
@@ -192,7 +192,7 @@ printf("%s\n", __FUNCTION__);
 		__func__, new_pkg->name, new_file, owner?owner->name:"<NULL>");
 
 	  if (!owner || (owner == old_pkg) || obs)
-	       file_hash_set_file_owner(new_file, new_pkg);
+	       file_hash_set_file_owner_with_old(new_file, new_pkg, old_pkg);
      }
 
      if (old_pkg) {
diff --git a/libopkg/pkg_hash.c b/libopkg/pkg_hash.c
index a99cf6b..96c299e 100644
--- a/libopkg/pkg_hash.c
+++ b/libopkg/pkg_hash.c
@@ -774,3 +774,21 @@ file_hash_set_file_owner(const char *file_name, pkg_t *owning_pkg)
 		owning_pkg->state_flag |= SF_FILELIST_CHANGED;
 	}
 }
+
+void
+file_hash_set_file_owner_with_old(const char *file_name, pkg_t *owning_pkg, pkg_t *old_owning_pkg)
+{
+	file_name = strip_offline_root(file_name);
+
+	hash_table_insert(&conf->file_hash, file_name, owning_pkg);
+
+	/* mark this package to have its filelist written */
+	owning_pkg->state_flag |= SF_FILELIST_CHANGED;
+
+	if (old_owning_pkg) {
+		pkg_get_installed_files(old_owning_pkg);
+		str_list_remove_elt(old_owning_pkg->installed_files, file_name);
+		/* mark the old package to have its filelist written */
+		old_owning_pkg->state_flag |= SF_FILELIST_CHANGED;
+	}
+}
diff --git a/libopkg/pkg_hash.h b/libopkg/pkg_hash.h
index b3cf3d1..36b0ca6 100644
--- a/libopkg/pkg_hash.h
+++ b/libopkg/pkg_hash.h
@@ -54,6 +54,7 @@ pkg_t *pkg_hash_fetch_installed_by_name_dest(const char *pkg_name,
 void file_hash_remove(const char *file_name);
 pkg_t *file_hash_get_file_owner(const char *file_name);
 void file_hash_set_file_owner(const char *file_name, pkg_t *pkg);
+void file_hash_set_file_owner_with_old(const char *file_name, pkg_t *owning_pkg, pkg_t *old_owning_pkg);
 
 #ifdef __cplusplus
 }
-- 
1.7.9.5

